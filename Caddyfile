{
  admin off
  persist_config off
  auto_https off

  log {
    format json
  }

  servers {
    trusted_proxies static private_ranges
  }
}

(lb_settings) {
  lb_policy round_robin
  lb_retries 100
  lb_try_duration 10s
  lb_try_interval 250ms
}

(passive_health_checks) {
  fail_duration 60s
  max_fails 300
  unhealthy_latency 5s
  unhealthy_request_count 200
}

:{$PORT} {
  log {
    format json
  }

  # -------------------------
  # Global CORS (ALL responses, incl. 4xx/5xx)
  # -------------------------
  header {
    Access-Control-Allow-Origin "*"
    Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Access-Control-Allow-Headers "Content-Type, Authorization, X-Request-Id"
    Access-Control-Expose-Headers "Content-Type, X-Request-Id"
    Access-Control-Max-Age "86400"
  }

  # -------------------------
  # Preflight
  # -------------------------
  @preflight method OPTIONS
  handle @preflight {
    respond "" 204
  }

  # -------------------------
  # Health (proxy to ai-structuring)
  # -------------------------
  handle /health {
    reverse_proxy {
      dynamic a {
        name ai-structuring.railway.internal
        port 8080
        refresh 1s
        dial_timeout 30s
        versions ipv4
      }
    }
  }

  # -------------------------
  # AI_CHAT (SSE-safe)
  # -------------------------
  handle /ai_chat/* {
    reverse_proxy {
      dynamic a {
        name ai-chat.railway.internal
        port 8080
        refresh 1s
        dial_timeout 30s
        versions ipv4
      }

      lb_retries 0
      lb_try_duration 0s
      lb_try_interval 0s

      flush_interval -1
      transport http {
        versions 1.1
        response_header_timeout 0
        read_timeout 0
        write_timeout 0
      }

      header_up Host {upstream_hostport}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      header_up X-Forwarded-For {remote_host}
      header_up Connection "keep-alive"

      header_down -Access-Control-Allow-Origin
      header_down -Access-Control-Allow-Methods
      header_down -Access-Control-Allow-Headers
      header_down -Access-Control-Allow-Credentials
      header_down -Access-Control-Expose-Headers
      header_down -Access-Control-Max-Age
    }
  }

  # -------------------------
  # AI_STRUCT
  # -------------------------
  handle /ai_struct/* {
    reverse_proxy {
      dynamic a {
        name ai-structuring.railway.internal
        port 8080
        refresh 1s
        dial_timeout 30s
        versions ipv4
      }

      lb_retries 0
      lb_try_duration 0s
      lb_try_interval 0s

      header_up Host {upstream_hostport}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      header_up X-Forwarded-For {remote_host}

      header_down -Access-Control-Allow-Origin
      header_down -Access-Control-Allow-Methods
      header_down -Access-Control-Allow-Headers
      header_down -Access-Control-Allow-Credentials
      header_down -Access-Control-Expose-Headers
      header_down -Access-Control-Max-Age
    }
  }

  # -------------------------
  # Image resizer
  # -------------------------
  handle /image_resize/* {
    reverse_proxy {
      dynamic a {
        name image-resizer.railway.internal
        port 3000
        refresh 1s
        dial_timeout 30s
        versions ipv4
      }

      # Keine Retries bei POST, sonst doppelte Verarbeitung
      lb_retries 0
      lb_try_duration 0s
      lb_try_interval 0s

      # Sinnvolle Timeouts f√ºr non-SSE Workloads
      transport http {
        versions 1.1
        response_header_timeout 60s
        read_timeout 300s
        write_timeout 300s
      }

      header_up Host {upstream_hostport}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      header_up X-Forwarded-For {remote_host}

      # Falls Upstream eigene CORS-Header setzt: dedupe
      header_down -Access-Control-Allow-Origin
      header_down -Access-Control-Allow-Methods
      header_down -Access-Control-Allow-Headers
      header_down -Access-Control-Allow-Credentials
      header_down -Access-Control-Expose-Headers
      header_down -Access-Control-Max-Age
    }
  }

  # -------------------------
  # Fallback
  # -------------------------
  respond "Not found" 404
}
