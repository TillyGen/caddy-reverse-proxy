{
  admin off
  persist_config off
  auto_https off

  log {
    format json
  }

  servers {
    trusted_proxies static private_ranges
  }
}

(lb_settings) {
  lb_policy round_robin
  lb_retries 100
  lb_try_duration 10s
  lb_try_interval 250ms
}

(passive_health_checks) {
  fail_duration 60s
  max_fails 300
  unhealthy_latency 5s
  unhealthy_request_count 200
}

:{$PORT} {
  log {
    format json
  }

  # -------------------------
  # Global CORS (ALL responses, incl. 4xx/5xx)
  # IMPORTANT:
  # - If you use cookies/credentials, DO NOT use "*"
  # - If you use Bearer tokens (Authorization header), "*" is fine
  # -------------------------
  header {
    Access-Control-Allow-Origin "*"
    Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Access-Control-Allow-Headers "Content-Type, Authorization, X-Request-Id"
    Access-Control-Expose-Headers "Content-Type, X-Request-Id"
    Access-Control-Max-Age "86400"
  }

  # -------------------------
  # Preflight
  # -------------------------
  @preflight method OPTIONS
  handle @preflight {
    respond "" 204
  }

  # -------------------------
  # Health
  # -------------------------
  respond /health "gateway-ok" 200

  # -------------------------
  # AI_CHAT (SSE-safe)
  # -------------------------
  handle /ai_chat/* {
  reverse_proxy {
    dynamic a {
      name ai-chat.railway.internal
      port 8080
      refresh 1s
      dial_timeout 30s
      versions ipv4 ipv6
    }

    # -------------------------
    # CRITICAL: No retries for POST bodies (prevents "invalid Read on closed Body")
    # -------------------------
    lb_retries 0
    lb_try_duration 0s
    lb_try_interval 0s

    # -------------------------
    # SSE hardening
    # -------------------------
    flush_interval -1
    transport http {
      versions 1.1
      response_header_timeout 0
      read_timeout 0
      write_timeout 0
    }

    header_up Host {upstream_hostport}
    header_up X-Forwarded-Proto {scheme}
    header_up X-Forwarded-Host {host}
    header_up X-Forwarded-For {remote_host}

    # Optional but helpful for streaming stability
    header_up Connection "keep-alive"

    # Remove any CORS headers coming from upstream to avoid duplicates
    header_down -Access-Control-Allow-Origin
    header_down -Access-Control-Allow-Methods
    header_down -Access-Control-Allow-Headers
    header_down -Access-Control-Allow-Credentials
    header_down -Access-Control-Expose-Headers
    header_down -Access-Control-Max-Age
  }
}

  # -------------------------
  # IMAGE
  # -------------------------
  handle /image/* {
    reverse_proxy {
      dynamic a {
        name ai-image.railway.internal
        port 8080
        refresh 1s
        dial_timeout 30s
        versions ipv4 ipv6
      }

      import lb_settings
      import passive_health_checks

      header_up Host {upstream_hostport}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      header_up X-Forwarded-For {remote_host}

      # Remove any CORS headers coming from upstream to avoid duplicates
      header_down -Access-Control-Allow-Origin
      header_down -Access-Control-Allow-Methods
      header_down -Access-Control-Allow-Headers
      header_down -Access-Control-Allow-Credentials
      header_down -Access-Control-Expose-Headers
      header_down -Access-Control-Max-Age
    }
  }

  # -------------------------
  # Fallback
  # -------------------------
  respond "Not found" 404
}